<!DOCTYPE html><meta content="width=device-width" name=viewport><link href=/bundle.css rel=stylesheet><script src=/bundle.js defer></script><script src=/check.js async></script><link href=/favicon.ico rel="shortcut icon"><link href=/favicon.svg rel=icon><title>对于修改迅雷9的经验之谈 - kkocdko's blog</title><meta content="一些关于迅雷9修改的笔记" name=description><main><article class=card><h1 id=对于修改迅雷9的经验之谈>对于修改迅雷9的经验之谈</h1><blockquote><p>侵删。</p><p>此文章仅针对迅雷9（不包括9.5预览版）的修改，对于其他版本的迅雷也许不适用。</p><p>前几天闲着无聊，整了个迅雷9的极限精简版。由于网络上有关修改迅雷的资料不多，修改过程中遇到了很多麻烦。所以在这，我想记录一下有关这几天折腾历程的经验。</p><p>这其实都是些没啥技术含量的奇技淫巧，看看就好，嗯，看看就好。</p></blockquote><h3 id=environment>Environment</h3><p>首先是环境配置。磨刀不误砍柴工，配置一个顺手的环境能省下大把时间。</p><ol><li><p>无论修改什么软件，如果你足够理智的话，一定要用Git或Svn进行版本控制，并且及时Commit。这样一来，如果不小心把软件改出了问题，才能快速地定位出错位置。如果之前没用过类似软件，可以尝试<a href=https://desktop.github.com>GitHub Desktop</a>或其他类似的GUI。</p></li><li><p>修改迅雷时需要用到一些工具，本人使用的有：</p></li></ol><table><thead><tr><th>Name</th><th>Website</th></tr></thead><tbody><tr><td>ExeinfoPe</td><td><a href=http://www.exeinfo.xn.pl>http://www.exeinfo.xn.pl</a></td></tr><tr><td>ResourceHacker</td><td><a href=http://www.angusj.com/resourcehacker>http://www.angusj.com/resourcehacker</a></td></tr><tr><td>DllExp</td><td><a href=http://www.nirsoft.net/utils/dll_export_viewer.html>http://www.nirsoft.net/utils/dll_export_viewer.html</a></td></tr><tr><td>js-beautify</td><td><a href=https://github.com/beautify-web/js-beautify>https://github.com/beautify-web/js-beautify</a></td></tr><tr><td>7zip</td><td><a href=https://www.7-zip.org>https://www.7-zip.org</a></td></tr><tr><td>pngquant</td><td><a href=https://pngquant.org>https://pngquant.org</a></td></tr><tr><td>leanify</td><td><a href=https://github.com/JayXon/Leanify>https://github.com/JayXon/Leanify</a></td></tr><tr><td>lua kit</td><td><a href=https://sourceforge.net/projects/luabinaries>https://sourceforge.net/projects/luabinaries</a></td></tr><tr><td>luadec</td><td><a href=https://github.com/sztupy/luadec51>https://github.com/sztupy/luadec51</a></td></tr><tr><td>JXar</td><td><a href=https://www.jayxon.com/jxar-2-1>https://www.jayxon.com/jxar-2-1</a></td></tr><tr><td>ThunderLua</td><td><a href=https://www.jayxon.com/thunderlua-0-2>https://www.jayxon.com/thunderlua-0-2</a></td></tr><tr><td>EmEditor</td><td><a href=https://www.emeditor.com>https://www.emeditor.com</a></td></tr><tr><td>SublimeText</td><td><a href=https://www.sublimetext.com>https://www.sublimetext.com</a></td></tr><tr><td>IcoFX</td><td><a href=https://icofx.ro>https://icofx.ro</a></td></tr><tr><td>PeExplorer</td><td><a href=http://www.heaventools.com/overview.htm>http://www.heaventools.com/overview.htm</a></td></tr><tr><td>WinHex</td><td><a href=http://www.winhex.net>http://www.winhex.net</a></td></tr></tbody></table><ol start=3><li>使用批处理或其他方式进行自动化打包、重启应用等操作。可以给批处理建立快捷方式，固定到任务栏或桌面上，再绑定一个快捷键。<ul><li>通常批处理文件无法直接固定到任务栏。这时可以在任意目录<code>右键&gt;新建&gt;快捷方式</code>，输入<code>cmd /c &lt;BatchFilePath&gt;</code>，然后将新建的快捷方式右键固定即可。</li></ul></li></ol><p>本人使用的部分批处理文件（仅供参考）：</p><pre><code class=language-batch>:: 打包资源并重启迅雷
@echo off
taskkill /f /im thunder.exe
jxar.exe -s -p 8 -v 7.9 &quot;D:\Temp\ThunderProject\working\Thunder9\Thunder\Xar\ThunderCore&quot;
start &quot;&quot; &quot;D:\Temp\ThunderProject\working\Thunder9\Program\Thunder.exe&quot;</code></pre><pre><code class=language-batch>:: Xml格式化
@echo off
ren &quot;%~dpnx1&quot; &quot;%~n1.html&quot;
call js-beautify -r &quot;%~dpn1.html&quot;
ren &quot;%~dpn1.html&quot; &quot;%~n1%~x1&quot;</code></pre><pre><code class=language-batch>:: 自动反编译Lua（不稳定）
copy &quot;%~dpnx1&quot; &quot;%~dpnx1.bak&quot;
ThunderLua.exe -d %~dpnx1
Luadec51.exe %1 &gt; %~dpn1.dec.lua</code></pre><h3 id=select-version-and-fusion>Select Version And Fusion</h3><p>对于UI组件，建议尽量使用早期版本，能得到更小的体积和更快速度。</p><p>对于ThunderDownloadSDK（以下简称TDSDK），应尽量使用新版。从迅雷9开始，TDSDK采用了可插拔模块化设计，通常只需对桥接UI和TDSDK的<code>/Program/DownloadKernel.dll</code>进行微量修改（甚至无需修改），就能组合任意版本TDSDK和UI。</p><p>由于公网IP的短缺和各国运营商对各P2P协议限制屏蔽方式不同，某些在其他国家可正常使用的软件/方法在天朝往往不好使。迅雷近年一直在与国内运营商互博，新版迅雷通常能得到更快的下载速度。使用新版TDSDK与旧版UI组合，就能在使用更轻量旧版UI的同时，享受新版迅雷带来的速度。</p><p>处于过渡版本的<code>DownloadKernel.dll</code>通常自带对前后不同TDSDK版本API的兼容，此时无需修改。若版本差别较大，可能需要手动处理兼容。通用做法是：用DllExp分别获得原始的和需要融合的<code>/Program/SDK/DownloadSDK.dll</code>函数导出表，对比导出函数。对于功能相同但被更名的函数，可直接在<code>DownloadKernel.dll</code>中修改调用语句。对于功能有差别的，也许可以自己写个转发（未尝试）。</p><blockquote><p>20200112：从迅雷9的某个测试版开始直至今日，TDSDK的各个基本API都没有变化。这给制作融合版带来了极大便利。</p></blockquote><h3 id=modify-ui>Modify UI</h3><h4 id=study-knowledge>Study Knowledge</h4><ul><li><p>要修改迅雷的界面，要懂得基本的<a href=https://www.w3school.com.cn/xml/xml_syntax.asp>Xml语法</a>。</p></li><li><p>查阅<a href=http://xldoc.xl7.xunlei.com/0000000018/index.html>BOLT引擎文档</a>。对于修改迅雷界面来说，只需简单浏览，了解大致内容即可。</p></li><li><p>如需修改交互逻辑，则要大致了解<a href=http://xldoc.xl7.xunlei.com/0000000018/00000000180001000031.html>Lua语法</a>和基本的反编译手法（在<a href=https://www.52pojie.cn>吾爱论坛</a>上可以找到很多）。</p></li></ul><h4 id=unpack-and-repack>Unpack And Repack</h4><ul><li><p>迅雷的UI相关文件存储在<code>/Thunder/Xar</code>。</p></li><li><p>使用JXar解包需要修改的Xar文件。通常，JXar能自动识别Xar文件版本和加密Seed。</p></li><li><p>打包时不一定要使用与之前相同的版本和Seed。迅雷<code>9.0 ~ 9.1</code>版本允许使用<code>Xar 7.9</code>和其他变种，能够识别任意非0的Seed。</p></li></ul><h4 id=modify-methods>Modify Methods</h4><ul><li><p>有不需要的组件，直接删掉标签即可避免元素生成。若出现副作用，大多是因为配套的Lua脚本尝试访问不存在的元素。这时可以反编译Lua脚本，去除对不存在元素的访问，也可在Xml文件中保留空标签，必要时使用<code>top</code>、<code>left</code>等定位属性将元素移出视野。</p></li><li><p>如需删除某个会被被其他脚本调用的Lua脚本，在调用的脚本上进行修改也许会比较麻烦。这时可以查看需要删除的Lua的函数导出表，自行编写一个Lua，在里边定义会被导出的空函数，即可达到类似目的。</p></li><li><p>对于图片资源的修改要注意透明通道，同时切记不要改动紫色|洋红色定位线。</p></li><li><p>配合<code>XLMessageBox(&quot;Hello World&quot;)</code>进行简单的调试。</p></li></ul><h4 id=modifiy-points>Modifiy Points</h4><ul><li><p>主窗口</p><ul><li>窗口边框和阴影资源名称：<code>ThunderCore.xar &gt; layout &gt; MainWnd &gt; MainWnd.xml &gt; xlue &gt; objtreetemplate#ThunderCore.Tree &gt; obj#MainWnd.Root &gt; children &gt; obj#MainWnd.MainBkg &gt; attr &gt; texture</code>，对应资源：<code>ThunderCore.xar &gt; res &gt; default &gt; MainWnd &gt; texture.shadowex.bkg.png</code></li><li>启动时窗口背景是否由灰色开始渐变：<code>ThunderCore.xar &gt; layout &gt; MainWnd &gt; MainWnd.xml &gt; xlue &gt; objtreetemplate#ThunderCore.Tree &gt; obj#MainWnd.Root &gt; children &gt; obj#MainWnd.Layout &gt; children &gt; obj#MainWnd.Bkg &gt; attr &gt; ReBodyBkg</code></li><li>顶栏（包括账户登录和皮肤管家、最小化、关闭等按钮）：<code>ThunderCore.xar &gt; layout &gt; MainWnd &gt; MainWnd.xml &gt; xlue &gt; objtreetemplate#ThunderCore.Tree &gt; obj#MainWnd.Root &gt; children &gt; obj#MainWnd.Layout &gt; children &gt; obj#MainWnd.Bkg &gt; children &gt; obj#MainWnd.HeadPanel</code></li><li>窗口属性（默认宽高、最小宽高、标题等）：<code>ThunderCore.xar &gt; layout &gt; MainWnd &gt; MainWnd.xml &gt; xlue &gt; objtreetemplate#ThunderCore.MainWnd &gt; attr</code></li></ul></li><li><p>右侧浏览器（包括设置页面）</p><ul><li>在主窗口的属性：<code>ThunderCore.xar &gt; layout &gt; MainWnd &gt; MainWnd.xml &gt; xlue &gt; objtreetemplate#ThunderCore.Tree &gt; obj#MainWnd.Root &gt; children &gt; obj#MainWnd.Layout &gt; children &gt; obj#MainWnd.Bkg &gt; children &gt; obj#BrowserCtrl &gt; attr</code>。可以将<code>left</code>改为<code>0</code>，<code>top</code>改为负数，达到不必调整窗口大小就能看到部分设置页面的目的</li><li>顶部Tab大小：``</li><li>顶部Tab背景：``</li></ul></li><li><p>设置页面</p><ul><li>左侧边距：``</li></ul></li><li><p>下载任务列表</p><ul><li>文件类型图标：``</li><li>无项目时的提示图片和文字：``</li><li>分隔线：``</li></ul></li><li><p>悬浮窗</p><ul><li>波浪动画：``</li><li>会员加速信息：``</li></ul></li><li><p>菜单：</p><ul><li>下载任务列表右键菜单图标：``</li><li>主窗口更多按钮、托盘、悬浮窗右键菜单图标：``</li></ul></li></ul><h3 id=pack-and-compress>Pack And Compress</h3><ul><li><p>打包Xar文件时，使用特定Seed能改善最终打包时的压缩率。经本人测试，使用<code>Seed 8</code>能让LZMA2（7z默认使用的压缩算法）达到最好压缩效果。</p><ul><li>某些时候使用LZMA能得到比LZMA2更佳的压缩率</li></ul></li><li><p>某些UI模块不需打包也能直接运行，原因未知，也许是迅雷内部开发时的遗产。利用这一点，尽量不打包Xar文件，可以省下一些文件头的空间。</p></li><li><p>使用pngquant和leanify可大幅度压缩UI资源文件。但pngquant无法确保洋红色定位线不偏色，因而不建议使用太强力的靠色参数。</p></li><li><p>在修改了Pe之后，数字签名会失效。可以使用PeExplorer或手动去除无效签名。</p></li></ul><blockquote><p>未完待续。</p><p>最近似乎有点忙，没啥时间来写这些玩意，可能要拖很久，长期鸽置也不是没有可能。</p></blockquote></article></main><header class=in id=extra></header>